name: dartzen
description: DartZen workspace mono-repo for managing dependencies and packages.
publish_to: "none"
version: 0.0.1

environment:
  sdk: ">=3.10.3 <4.0.0"

workspace:
  - packages/dartzen_core
  - packages/dartzen_ui_navigation
  - packages/dartzen_ui_navigation/example
  - packages/dartzen_firestore
  - packages/dartzen_transport
  - packages/dartzen_localization
  - packages/dartzen_identity
  - packages/dartzen_cache
  - packages/dartzen_storage
  - packages/dartzen_server
  - packages/dartzen_ui_identity
  - packages/dartzen_ui_identity/example
  - apps/ZenDemo/dartzen_demo_contracts
  - apps/ZenDemo/dartzen_demo_server
  - apps/ZenDemo/dartzen_demo_client

dependency_overrides:
  cli_util: ^0.4.2
  collection: ^1.19.1
  dio: ^5.9.0
  flutter:
    sdk: flutter
  flutter_hooks: ^0.21.3+1
  go_router: ^17.0.0
  google_fonts: ^6.3.3
  intl: ^0.20.2

dev_dependencies:
  flutter_lints: ^6.0.0
  import_sorter: ^4.6.0
  melos: ^7.3.0

melos:
  scripts:
    analyze:
      exec: dart analyze .
      description: Run dart analyze in all packages.
    format:
      exec: dart format .
      description: Run dart format in all packages.
    format:check:
      exec: dart format --set-exit-if-changed .
      description: Run dart format --set-exit-if-changed in all packages.
    test:
      run: |
        # Flutter packages (with --dart-define)
        # `flutter test --coverage` does not accept a value for the flag; run
        # the test and then move the produced `coverage/` dir to a per-run
        # name so the CI script can find per-matrix outputs.
        melos exec --scope="dartzen_core,dartzen_ui_navigation,dartzen_ui_identity,dartzen_demo_client,dartzen_localization" -- 'sh -c "flutter test --dart-define=DZ_PLATFORM=macos --dart-define=DZ_ENV=dev --coverage || true; if [ -d coverage ]; then mv coverage coverage_tmp || true; mkdir -p coverage || true; mv coverage_tmp coverage/coverage_dev_macos_flutter || true; fi"'
        # Dart packages (pass compile-time defines via `dart run --define` so constants are tree-shaken correctly)
        melos exec --scope="dartzen_transport,dartzen_storage,dartzen_identity,dartzen_firestore,dartzen_cache,dartzen_server,dartzen_demo_server,dartzen_demo_contracts" -- "dart run --define=DZ_IS_TEST=true --define=DZ_ENV=dev test --coverage=coverage"
      description: Run all Dart & Flutter tests with coverage, using flutter test for any package that depends on Flutter
    publish:
      exec: dart pub publish --dry-run
      description: Publish all dartzen_* packages to pub.dev (dry-run mode).
      packageFilters:
        scope: "dartzen_*"
    run:android:
      exec: flutter run -d android --dart-define=DZ_PLATFORM=android --dart-define=DZ_ENV=dev
      description: Run the app on Android (debug mode).
    run:android:profile:
      exec: flutter run -d android --dart-define=DZ_PLATFORM=android --dart-define=DZ_ENV=prd --profile
      description: Run the app on Android (profile mode).
    run:android:release:
      exec: flutter run -d android --dart-define=DZ_PLATFORM=android --dart-define=DZ_ENV=prd --release
      description: Run the app on Android (release mode).
    run:ios:
      exec: flutter run -d ios --dart-define=DZ_PLATFORM=ios --dart-define=DZ_ENV=dev
      description: Run the app on iOS (debug mode).
    run:ios:profile:
      exec: flutter run -d ios --dart-define=DZ_PLATFORM=ios --dart-define=DZ_ENV=prd --profile
      description: Run the app on iOS (profile mode).
    run:ios:release:
      exec: flutter run -d ios --dart-define=DZ_PLATFORM=ios --dart-define=DZ_ENV=prd --release
      description: Run the app on iOS (release mode).
    run:web:
      exec: flutter run -d chrome --dart-define=DZ_PLATFORM=web --dart-define=DZ_ENV=dev
      description: Run the app on Web (debug mode).
    run:web:profile:
      exec: flutter run -d chrome --dart-define=DZ_PLATFORM=web --dart-define=DZ_ENV=prd --profile
      description: Run the app on Web (profile mode).
    run:web:release:
      exec: flutter run -d chrome --dart-define=DZ_PLATFORM=web --dart-define=DZ_ENV=prd --release
      description: Run the app on Web (release mode).
    run:desktop:windows:
      exec: flutter run -d windows --dart-define=DZ_PLATFORM=windows --dart-define=DZ_ENV=dev
      description: Run the app on Windows (debug mode).
    run:desktop:windows:profile:
      exec: flutter run -d windows --dart-define=DZ_PLATFORM=windows --dart-define=DZ_ENV=prd --profile
      description: Run the app on Windows (profile mode).
    run:desktop:windows:release:
      exec: flutter run -d windows --dart-define=DZ_PLATFORM=windows --dart-define=DZ_ENV=prd --release
      description: Run the app on Windows (release mode).
    run:desktop:macos:
      exec: flutter run -d macos --dart-define=DZ_PLATFORM=macos --dart-define=DZ_ENV=dev
      description: Run the app on macOS (debug mode).
    run:desktop:macos:profile:
      exec: flutter run -d macos --dart-define=DZ_PLATFORM=macos --dart-define=DZ_ENV=prd --profile
      description: Run the app on macOS (profile mode).
    run:desktop:macos:release:
      exec: flutter run -d macos --dart-define=DZ_PLATFORM=macos --dart-define=DZ_ENV=prd --release
      description: Run the app on macOS (release mode).
    run:desktop:linux:
      exec: flutter run -d linux --dart-define=DZ_PLATFORM=linux --dart-define=DZ_ENV=dev
      description: Run the app on Linux (debug mode).
    run:desktop:linux:profile:
      exec: flutter run -d linux --dart-define=DZ_PLATFORM=linux --dart-define=DZ_ENV=prd --profile
      description: Run the app on Linux (profile mode).
    run:desktop:linux:release:
      exec: flutter run -d linux --dart-define=DZ_PLATFORM=linux --dart-define=DZ_ENV=prd --release
      description: Run the app on Linux (release mode).
    example:navigation:web:
      exec: flutter run -d chrome --dart-define=DZ_PLATFORM=web --dart-define=DZ_ENV=dev
      packageFilters:
        scope: dartzen_ui_navigation_example
    example:navigation:ios:
      exec: flutter run --dart-define=DZ_PLATFORM=ios --dart-define=DZ_ENV=dev
      packageFilters:
        scope: dartzen_ui_navigation_example
    example:identity:web:
      exec: flutter run -d chrome --dart-define=DZ_PLATFORM=web --dart-define=DZ_ENV=dev
      packageFilters:
        scope: dartzen_ui_identity_example
    example:identity:ios:
      exec: flutter run --dart-define=DZ_PLATFORM=ios --dart-define=DZ_ENV=dev
      packageFilters:
        scope: dartzen_ui_identity_example
    test:matrix:
      run: |
        PACKAGE=${PACKAGE:-packages/dartzen_storage}
        ENVS="dev prd"
        PLATFORMS="web linux android"
        # Flutter packages should use `flutter test` (they depend on Flutter)
        FLUTTER_SCOPE="dartzen_core,dartzen_ui_navigation,dartzen_ui_identity,dartzen_demo_client,dartzen_localization"
        # Dart-only packages use `dart run test`
        DART_SCOPE="dartzen_transport,dartzen_storage,dartzen_identity,dartzen_firestore,dartzen_cache,dartzen_server,dartzen_demo_server,dartzen_demo_contracts"

        for e in $ENVS; do
          for p in $PLATFORMS; do
            echo "Running flutter tests for DZ_ENV=$e DZ_PLATFORM=$p"
            # When targeting web, compile tests for Chrome so conditional imports
            # select the web implementation (`dart.library.html`). For other
            # platforms, run the default VM platform so `dart.library.io` is
            # available for native implementations.
            if [ "$p" = "web" ]; then
              melos exec --scope="$FLUTTER_SCOPE" -- "sh -c \"flutter test --platform=chrome --dart-define=DZ_PLATFORM=$p --dart-define=DZ_ENV=$e --coverage || true; if [ -d coverage ]; then mv coverage coverage_tmp || true; mkdir -p coverage || true; mv coverage_tmp coverage/coverage_${e}_${p}_flutter || true; fi\""
            else
              melos exec --scope="$FLUTTER_SCOPE" -- "sh -c \"flutter test --dart-define=DZ_PLATFORM=$p --dart-define=DZ_ENV=$e --coverage || true; if [ -d coverage ]; then mv coverage coverage_tmp || true; mkdir -p coverage || true; mv coverage_tmp coverage/coverage_${e}_${p}_flutter || true; fi\""
            fi

            echo "Running dart tests for DZ_ENV=$e DZ_PLATFORM=$p"
            melos exec --scope="$DART_SCOPE" -- "dart run --define=DZ_IS_TEST=true --define=DZ_ENV=$e --define=DZ_PLATFORM=$p test --coverage=coverage/coverage_${e}_${p}_dart"
          done
        done
